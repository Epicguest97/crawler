name: Selenium Crawler Workflow

on:
  push:
    branches:
      - main

jobs:
  selenium-crawl:
    runs-on: ubuntu-22.04

    steps:
    # Checkout the repository code
    - name: Checkout repository
      uses: actions/checkout@v2

    # Set up Python
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    # Install dependencies directly (without requirements.txt)
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip curl jq
        sudo apt-get install -y python3-pip
        pip3 install selenium  # Install Selenium directly

    # Install Chrome for Testing and matching ChromeDriver
    - name: Install Chrome for Testing and matching ChromeDriver
      run: |
        curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json > versions.json
        
        CHROME_VERSION=$(jq -r '.channels.Stable.version' versions.json)
        DRIVER_URL=$(jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform == "linux64") | .url' versions.json)
        CHROME_URL=$(jq -r '.channels.Stable.downloads.chrome[] | select(.platform == "linux64") | .url' versions.json)

        echo "Installing Chrome for Testing $CHROME_VERSION"

        wget "$CHROME_URL" -O chrome-linux.zip
        unzip chrome-linux.zip
        sudo mv chrome-linux64 /opt/chrome

        sudo ln -s /opt/chrome/chrome /usr/local/bin/google-chrome

        wget "$DRIVER_URL" -O chromedriver-linux64.zip
        unzip chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver

        google-chrome --version
        chromedriver --version

    # Run the crawler
    - name: Run Crawler
      run: |
        python3 crawler.py  # Ensure your Python file is named 'crawler.py'

    # Upload the JSON output as an artifact
    - name: Upload crawled PDFs
      uses: actions/upload-artifact@v4
      with:
        name: crawled-pdfs
        path: ./pdf_results/*.json
